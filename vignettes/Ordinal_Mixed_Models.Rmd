---
title: "Mixed Models for Ordinal Data"
author: "Dimitris Rizopoulos"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Mixed Models for Ordinal Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library("GLMMadaptive")
library("lattice")
```

## Continuation Ratio Model
### Definition
In many applications the outcome of interest is an ordinal variable, i.e., a categorical variable with a natural ordering of its levels. For example, an ordinal response may represent levels of a standard measurement scale, such as severity of pain (none, mild, moderate, severe) or economic status, with three categories (low, medium and high). A variety of statistical models, namely,  proportional odds, adjacent category, stereotype logit, and continuation ratio can be used for an ordinal response. Here we focus on the continuation ratio model. Let $y_i$ denote a vector of grouped/clustered outcome for
the $i$-th sample unit ($i = 1, \ldots, n$). We assume that each measurement in $y_{ij}$, $(j = 1, \ldots, n_i)$ can take values $K + 1$ possible values in the ordered set $\{0, 1, \ldots, K\}$. The continuation ratio mixed effects model is based on conditional probabilities for this outcome $y_i$. Namely, the *backward* formulation of the model postulates:
\[
\log \{ \Pr(y_{ij} = k \mid y_{ij} \leq k) \} = \alpha_k + x_{ij}^\top \beta + z_{ij}^\top b_i,
\]
whereas the forward formulation is:
\[
\log \{ \Pr(y_{ij} = k \mid y_{ij} \geq k) \} = \alpha_k + x_{ij}^\top \beta + z_{ij}^\top b_i,
\]
where $x_{ij}$ denotes the $j$-th row of the fixed effects design matrix $X_i$, with the corresponding fixed effects coefficients denoted by $\beta$, $z_{ij}$ denotes the $j$-th row of the random effects design matrix $Z_i$ with corresponding random effects $b_i$, which follow a normal distribution with mean zero and variance-covariance matrix $D$. The coefficients $\alpha_k$ denote the threshold parameters for each category. For identification reasons, $K$ threshold parameters are estimated.

The backward formulation is commonly used when progression through disease states from none, mild, moderate,severe is represented by increasing integer values, and interest lies in estimating the odds ofmore severe disease compared to less severe disease. The forward formulation specifies that subjects have to 'pass through' one category to get to the next one. The forward formulation is a equivalent to a discrete version of Cox proportional hazards models.

### Marginal Probabilities
In the backward formulation the marginal probabilities for each category are given by
$$
\Pr(y_{ij} = k) = 
\left \{
\begin{array}{ll}
\frac{\exp(\alpha_k + x_{ij}^\top \beta + z_{ij}^\top b_i)}{1 + \exp(\alpha_k + x_{ij}^\top \beta + z_{ij}^\top b_i)} & k = K,\\\\
\frac{\exp(\alpha_k + x_{ij}^\top \beta + z_{ij}^\top b_i)}{1 + \exp(\alpha_k + x_{ij}^\top \beta + z_{ij}^\top b_i)} \times 
\prod_{k' > k} \frac{1}{1 + \exp(\alpha_{k'} + x_{ij}^\top \beta + z_{ij}^\top b_i)}& k < K,
\end{array}
\right.
$$
whereas in the forward formulation they get the form:
$$
\Pr(y_{ij} = k) = 
\left \{
\begin{array}{ll}
\frac{\exp(\alpha_k + x_{ij}^\top \beta + z_{ij}^\top b_i)}{1 + \exp(\alpha_k + x_{ij}^\top \beta + z_{ij}^\top b_i)} & k = 0,\\\\
\frac{\exp(\alpha_k + x_{ij}^\top \beta + z_{ij}^\top b_i)}{1 + \exp(\alpha_k + x_{ij}^\top \beta + z_{ij}^\top b_i)} \times 
\prod_{k' < k} \frac{1}{1 + \exp(\alpha_{k'} + x_{ij}^\top \beta + z_{ij}^\top b_i)}& k > 0,
\end{array}
\right.
$$

**Note:** These are marginal probabilities over the categories of the ordinal response; as the above formulation shows, these are still conditional on the random effects.

### Estimation
An advantage of the continuation ratio model is that its likelihood canbe easily re-expresse such that it can be fitted with software the fits (mixed effects) logistic regression. The details behind this re-expression of the likelihood are given, for example, in [Armstrong and Sloan (1989)](https://doi.org/10.1093/oxfordjournals.aje.a115109), and [Berridge and Whitehead (1991)](https://doi.org/10.1002/sim.4780101108).


## An Example
### Simulated Data
We start by simulating some data for an ordinal longitudinal outcome under the forward formulation of the continuation ratio model:
```{r, sim_data, eval = TRUE}
set.seed(1234)
n <- 300 # number of subjects
K <- 8 # number of measurements per subject
t_max <- 15 # maximum follow-up time

# we constuct a data frame with the design: 
# everyone has a baseline measurment, and then measurements at random follow-up times
DF <- data.frame(id = rep(seq_len(n), each = K),
                 time = c(replicate(n, c(0, sort(runif(K - 1, 0, t_max))))),
                 sex = rep(gl(2, n/2, labels = c("male", "female")), each = K))

# design matrices for the fixed and random effects
X <- model.matrix(~ sex * time, data = DF)[, -1]
Z <- model.matrix(~ time, data = DF)

thrs <- c(-1.5, 0, 0.9) # thresholds for the different ordinal categories
betas <- c(-0.25, 0.24, -0.05) # fixed effects coefficients
D11 <- 0.48 # variance of random intercepts
D22 <- 0.1 # variance of random slopes

# we simulate random effects
b <- cbind(rnorm(n, sd = sqrt(D11)), rnorm(n, sd = sqrt(D22)))
# linear predictor
eta_y <- drop(X %*% betas + rowSums(Z * b[DF$id, , drop = FALSE]))
# linear predictor for each category under forward CR formulation
# for the backward formulation, check the note below
eta_y <- outer(eta_y, thrs, "+")
# marginal probabilities per category
mprobs <- cr_marg_probs(eta_y)
# we simulate ordinal longitudinal data
DF$y <- unname(apply(mprobs, 1, sample, x = ncol(mprobs), size = 1, replace = TRUE))
```

**Note:** If we wanted to simulate from the backward formulation of continuation ratio model, we need to reverse the ordering of the thresholds, namely the line `eta_y <- outer(eta_y, thrs, "+")` of the code above should be replaced by `eta_y <- outer(eta_y, rev(thrs), "+")`, and also specify in the call to `cr_marg_probs()` that `direction = "backward"`.

### Data Preparation Forward Formulation

```{r, set_up_data, eval = TRUE}
cr_vals <- cr_setup(DF$y)
cr_data <- DF[cr_vals$subs, ]
cr_data$y_new <- cr_vals$y
cr_data$cohort <- cr_vals$cohort
```

### Basic Continuation Ratio Model

```{r, random_intercepts, eval = TRUE}
fm <- mixed_model(y_new ~ cohort + sex + time, random = ~ 1 | id, 
                  data = cr_data, family = binomial())

fm
```

### Relaxing the CR Assumption

```{r, relax_CR_assumption, eval = TRUE}
gm <- mixed_model(y_new ~ cohort * sex + time, random = ~ 1 | id, 
                  data = cr_data, family = binomial())

gm
```

### Effect Plots of Conditional Probabilities

```{r, effect_plot_data, eval = TRUE}
nDF <- with(cr_data, expand.grid(cohort = levels(cohort), sex = levels(sex), 
                                 time = seq(0, 10, length.out = 55)))

plot_data <- effectPlotData(fm, nDF)
```

```{r, CR_probs_plot, eval = TRUE, fig.align = "center", fig.width = 8.5, fig.height = 7.5}
expit <- function (x) exp(x) / (1 + exp(x))
my.panel.bands <- function(x, y, upper, lower, fill, col, subscripts, ..., font, 
                           fontface) {
    upper <- upper[subscripts]
    lower <- lower[subscripts]
    panel.polygon(c(x, rev(x)), c(upper, rev(lower)), col = fill, border = FALSE, ...)
}

xyplot(expit(pred) ~ time | sex, group = cohort, data = plot_data, 
       upper = expit(plot_data$upp), low = expit(plot_data$low), type = "l",
       panel = function (x, y, ...) {
           panel.superpose(x, y, panel.groups = my.panel.bands, ...)
           panel.xyplot(x, y, lwd = 2,  ...)
       }, xlab = "Follow-up time", ylab = "Continuation Ratio Probabilities")
```

### Effect Plots of Marginal Probabilities

```{r, effect_plot_data_marg, eval = TRUE}
plot_data_m <- effectPlotData(fm, nDF, CR_cohort_varname = "cohort")
```

```{r, CR_probs_plot_marg, eval = TRUE, fig.align = "center", fig.width = 8.5, fig.height = 7.5}
xyplot(expit(pred) ~ time | sex, group = ordinal_response, data = plot_data_m, 
       upper = expit(plot_data_m$upp), low = expit(plot_data_m$low), type = "l",
       panel = function (x, y, ...) {
           panel.superpose(x, y, panel.groups = my.panel.bands, ...)
           panel.xyplot(x, y, lwd = 2,  ...)
       }, xlab = "Follow-up time", ylab = "Marginal Probabilities")
```

